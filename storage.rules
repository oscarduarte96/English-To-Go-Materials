rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // 1. PRODUCTOS (Archivos de venta)
    // Estructura: /products/{userId}/{fileName}
    match /products/{userId}/{fileName} {
      // Cualquiera puede leer (necesario para la descarga post-compra)
      allow read: if true;
      
      // SOLO el due침o de la carpeta puede subir/borrar
      // Limitamos el tama침o a 500MB por seguridad
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 500 * 1024 * 1024; 
    }

    // 2. PREVIEWS (Im치genes de portada)
    // Estructura: /previews/{userId}/{fileName}
    match /previews/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   // Eliminated strict contentType check to prevent false positives
                   && request.resource.size < 20 * 1024 * 1024;
    }
    
    // 3. AVATARES DE USUARIO
    match /avatars/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // BLOQUEO GENERAL
    // Cualquier otra ruta no especificada arriba est치 prohibida
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
