<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acceso | English To Go Materials</title>
    <link rel="icon" href="../assets/img/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="module" src="../assets/js/components.js"></script>

    <style>
        /* Ajuste visual para las pestañas activas/inactivas */
        .tab-btn { position: relative; cursor: pointer; transition: all 0.3s ease; }
        .tab-active { color: #4f46e5; font-weight: 700; background-color: rgba(255,255,255,0.8); }
        .tab-active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
            border-top-left-radius: 4px; border-top-right-radius: 4px;
        }
        .tab-inactive { color: #64748b; font-weight: 500; }
        .tab-inactive:hover { background-color: rgba(248,250,252, 0.8); color: #475569; }
    </style>
</head>

<body class="bg-slate-50 relative text-slate-900 antialiased flex flex-col min-h-screen">

    <app-header no-sidebar="true" no-cart="true"></app-header>

    <div class="blob-indigo absolute top-0 right-0 w-[500px] h-[500px] bg-indigo-500/10 rounded-full blur-3xl -z-10 pointer-events-none"></div>
    <div class="blob-cyan absolute bottom-0 left-0 w-[500px] h-[500px] bg-cyan-500/10 rounded-full blur-3xl -z-10 pointer-events-none"></div>

    <main class="flex-grow min-h-screen pt-[90px] pb-12 px-4 flex flex-col items-center justify-center relative z-10 w-full">
        
        <div class="w-full max-w-[440px] mx-auto animate-fade-in">
            
            <div class="card glass-panel overflow-hidden border-0 ring-1 ring-slate-900/5 shadow-2xl shadow-indigo-500/10">
                
                <div class="h-1.5 w-full bg-gradient-to-r from-indigo-600 via-purple-500 to-cyan-500"></div>

                <div id="auth-tabs" class="flex border-b border-slate-100 bg-slate-50/50">
                    <div id="tab-login" class="flex-1 py-4 text-center text-sm tab-btn tab-active" onclick="switchTab('login')">
                        INGRESAR
                    </div>
                    <div id="tab-register" class="flex-1 py-4 text-center text-sm tab-btn tab-inactive" onclick="switchTab('register')">
                        CREAR CUENTA
                    </div>
                </div>

                <div class="p-6 sm:p-8">

                    <div id="view-login" class="animate-fade-in">
                        <div class="text-center mb-6">
                            <h1 class="text-2xl font-black text-slate-800 tracking-tight">Bienvenido de nuevo</h1>
                            <p class="text-slate-500 text-xs font-medium mt-1">Accede a tu panel de materiales.</p>
                        </div>

                        <button id="btn-google-login" type="button" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl transition-all border border-slate-200 shadow-sm hover:shadow-md mb-5 group">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="G" class="group-hover:scale-110 transition-transform">
                            <span class="text-sm">Continuar con Google</span>
                        </button>

                        <div class="relative flex items-center mb-5">
                            <div class="flex-grow border-t border-slate-200"></div>
                            <span class="flex-shrink-0 mx-3 text-slate-400 text-[10px] uppercase font-bold tracking-widest">O con correo</span>
                            <div class="flex-grow border-t border-slate-200"></div>
                        </div>

                        <form id="form-login" class="space-y-4">
                            <div class="space-y-1">
                                <label class="label">Correo Electrónico</label>
                                <div class="relative">
                                    <i class="fa-regular fa-envelope absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                    <input type="email" id="login-email" placeholder="nombre@correo.com" required 
                                        class="input-field pl-10">
                                </div>
                            </div>

                            <div class="space-y-1">
                                <div class="flex justify-between items-center px-1">
                                    <label class="label mb-0">Contraseña</label>
                                    <button type="button" onclick="switchView('recovery')" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 hover:underline">
                                        ¿Olvidaste la contraseña?
                                    </button>
                                </div>
                                <div class="relative">
                                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                    <input type="password" id="login-pass" placeholder="••••••••" required
                                        class="input-field pl-10">
                                </div>
                            </div>

                            <button type="submit" id="btn-submit-login" class="btn btn-primary w-full justify-center mt-2 shadow-lg shadow-indigo-500/20">
                                <span>Ingresar</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </form>
                    </div>

                    <div id="view-register" class="hidden animate-fade-in">
                        <div class="text-center mb-6">
                            <h1 class="text-2xl font-black text-slate-800 tracking-tight">Crea tu cuenta</h1>
                            <p class="text-slate-500 text-xs font-medium mt-1">Únete a la comunidad de English To Go.</p>
                        </div>

                        <button id="btn-google-register" type="button" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl transition-all border border-slate-200 shadow-sm hover:shadow-md mb-5 group">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="G" class="group-hover:scale-110 transition-transform">
                            <span class="text-sm">Registrarse con Google</span>
                        </button>

                        <div class="relative flex items-center mb-5">
                            <div class="flex-grow border-t border-slate-200"></div>
                            <span class="flex-shrink-0 mx-3 text-slate-400 text-[10px] uppercase font-bold tracking-widest">O llena tus datos</span>
                            <div class="flex-grow border-t border-slate-200"></div>
                        </div>

                        <form id="form-register" class="space-y-3">
                            <div class="space-y-1">
                                <label class="label">Nombre Completo</label>
                                <div class="relative">
                                    <i class="fa-regular fa-user absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                    <input type="text" id="reg-name" placeholder="Ej: Oscar Duarte" required 
                                        class="input-field pl-10">
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="label">Correo Electrónico</label>
                                <div class="relative">
                                    <i class="fa-regular fa-envelope absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                    <input type="email" id="reg-email" placeholder="tu@email.com" required 
                                        class="input-field pl-10">
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="label">Contraseña</label>
                                <div class="relative">
                                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                    <input type="password" id="reg-pass" placeholder="Mínimo 6 caracteres" required minlength="6"
                                        class="input-field pl-10">
                                </div>
                            </div>

                            <button type="submit" id="btn-submit-register" class="btn btn-primary w-full justify-center mt-4">
                                <span>Crear mi Cuenta</span>
                            </button>
                        </form>
                    </div>

                    <div id="view-recovery" class="hidden animate-fade-in text-center">
                        <button onclick="switchView('login')" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-slate-600 text-[10px] font-bold uppercase tracking-wider transition-colors mx-auto">
                            <i class="fa-solid fa-arrow-left"></i> Volver al ingreso
                        </button>
                        
                        <div class="w-14 h-14 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 rotate-3">
                            <i class="fa-solid fa-key text-xl"></i>
                        </div>
                        
                        <h2 class="text-xl font-black text-slate-800 mb-2">Recuperar Acceso</h2>
                        <p class="text-slate-500 text-xs mb-6">Ingresa tu correo y te enviaremos un enlace mágico.</p>

                        <form id="form-recovery" class="space-y-4 text-left">
                            <div class="relative">
                                <i class="fa-regular fa-envelope absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                                <input type="email" id="rec-email" placeholder="ejemplo@correo.com" required 
                                    class="input-field pl-10">
                            </div>
                            
                            <button type="submit" id="btn-submit-recovery" class="btn btn-primary w-full justify-center">
                                Enviar Enlace
                            </button>
                        </form>
                    </div>

                    <div id="feedback-msg" class="hidden mt-4 p-3 rounded-lg text-xs font-bold text-center flex items-center justify-center gap-2 animate-fade-in">
                        <i id="feedback-icon" class="fa-solid"></i>
                        <span id="feedback-text"></span>
                    </div>

                </div>

                <div class="bg-slate-50/80 px-8 py-4 border-t border-slate-100 text-center backdrop-blur-sm">
                    <p class="text-[10px] text-slate-400 font-medium">
                        Al continuar, aceptas nuestros <a href="#" class="underline hover:text-indigo-600">Términos y Condiciones</a>.
                    </p>
                </div>

            </div>
        </div>
    </main>

    <app-footer></app-footer>

    <script type="module">
        // Importamos la lógica pura desde auth-logic.js
        import { loginUser, registerUser, loginWithGoogle, recoverPassword } from './auth-logic.js';

        // --- GESTIÓN DE PESTAÑAS Y VISTAS ---
        const views = {
            login: document.getElementById('view-login'),
            register: document.getElementById('view-register'),
            recovery: document.getElementById('view-recovery')
        };
        const tabs = {
            login: document.getElementById('tab-login'),
            register: document.getElementById('tab-register'),
            container: document.getElementById('auth-tabs')
        };

        // Función global para el HTML onclick
        window.switchTab = (mode) => {
            hideFeedback();
            // Mostrar tabs container (por si venimos de recovery)
            tabs.container.classList.remove('hidden');

            if (mode === 'login') {
                views.login.classList.remove('hidden');
                views.register.classList.add('hidden');
                views.recovery.classList.add('hidden');
                
                tabs.login.classList.add('tab-active');
                tabs.login.classList.remove('tab-inactive');
                tabs.register.classList.remove('tab-active');
                tabs.register.classList.add('tab-inactive');
            } else {
                views.register.classList.remove('hidden');
                views.login.classList.add('hidden');
                views.recovery.classList.add('hidden');

                tabs.register.classList.add('tab-active');
                tabs.register.classList.remove('tab-inactive');
                tabs.login.classList.remove('tab-active');
                tabs.login.classList.add('tab-inactive');
            }
        };

        window.switchView = (viewName) => {
            hideFeedback();
            // Ocultar todas
            Object.values(views).forEach(el => el.classList.add('hidden'));
            
            if(viewName === 'recovery') {
                views.recovery.classList.remove('hidden');
                tabs.container.classList.add('hidden'); // Ocultar tabs en recovery
            } else if (viewName === 'login') {
                window.switchTab('login');
            }
        };

        // --- UTILIDADES ---
        const showFeedback = (type, msg) => {
            const el = document.getElementById('feedback-msg');
            const icon = document.getElementById('feedback-icon');
            const text = document.getElementById('feedback-text');

            el.classList.remove('hidden', 'bg-red-50', 'text-red-600', 'border-red-100', 'bg-emerald-50', 'text-emerald-600', 'border-emerald-100');
            
            if (type === 'error') {
                el.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-100');
                icon.className = 'fa-solid fa-circle-exclamation';
            } else {
                el.classList.add('bg-emerald-50', 'text-emerald-600', 'border', 'border-emerald-100');
                icon.className = 'fa-solid fa-circle-check';
            }
            
            text.innerText = msg;
            el.classList.remove('hidden');
        };

        const hideFeedback = () => document.getElementById('feedback-msg').classList.add('hidden');

        const setLoading = (btnId, isLoading, originalText = '') => {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.dataset.original = btn.innerHTML; // Guardar contenido original
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Procesando...';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.original || originalText;
            }
        };

        const redirect = () => window.location.href = '../panel/dashboard.html';

        // --- LOGICA FORMULARIOS ---

        // 1. LOGIN
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            setLoading('btn-submit-login', true);
            
            const result = await loginUser(email, pass);
            
            if (result.success) {
                redirect();
            } else {
                showFeedback('error', result.error);
                setLoading('btn-submit-login', false);
            }
        });

        // 2. REGISTRO
        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-pass').value
            };

            setLoading('btn-submit-register', true);

            const result = await registerUser(data);

            if (result.success) {
                redirect();
            } else {
                showFeedback('error', result.error);
                setLoading('btn-submit-register', false);
            }
        });

        // 3. RECUPERACIÓN
        document.getElementById('form-recovery').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('rec-email').value;
            
            setLoading('btn-submit-recovery', true);
            
            const result = await recoverPassword(email);
            
            if (result.success) {
                showFeedback('success', 'Enlace enviado. Revisa tu correo.');
                document.getElementById('form-recovery').reset();
            } else {
                showFeedback('error', result.error);
            }
            setLoading('btn-submit-recovery', false);
        });

        // 4. GOOGLE AUTH (Compartido para ambos botones)
        const handleGoogle = async () => {
            const result = await loginWithGoogle();
            if (result.success) {
                redirect();
            } else {
                showFeedback('error', result.error || 'Error al conectar con Google');
            }
        };

        document.getElementById('btn-google-login').addEventListener('click', handleGoogle);
        document.getElementById('btn-google-register').addEventListener('click', handleGoogle);

        // --- INICIALIZACIÓN ---
        // Detectar URL param ?mode=register
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'register') {
            switchTab('register');
        } else {
            switchTab('login');
        }

    </script>
</body>
</html>